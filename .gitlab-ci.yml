# Include shared CI
include:
    - project: "epi2melabs/ci-templates"
      file: "wf-containers.yaml"

variables:
    # We'll use the single-file case for these runs
    NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
    NF_PROCESS_FILES: "modules/local/wf-somatic-snv.nf"
    NF_WORKFLOW_OPTS: "--snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
            --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
            --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
            --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
            --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
            -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
    CI_FLAVOUR: "new" # set to "classic" for old-style CI
    NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,wf_build_regions"

docker-run:
    # Exclude artifacts to speed up execution
    artifacts:
        when: always
        paths:
            - ${CI_PROJECT_NAME}
            - .nextflow.log
        exclude:
            - ${CI_PROJECT_NAME}/**/*.bam
            - ${CI_PROJECT_NAME}/**/*.cram
            - ${CI_PROJECT_NAME}/**/*.fa
            - ${CI_PROJECT_NAME}/**/*.fna
            - ${CI_PROJECT_NAME}/**/*.fasta
            - ${CI_PROJECT_NAME}/**/ref_cache/**
    # Define a 1D job matrix to inject a variable named MATRIX_NAME into
    #   the CI environment, we can use the value of MATRIX_NAME to determine
    #   which options to apply as part of the rules block below
    # NOTE There is a slightly cleaner way to define this matrix to include
    #   the variables, but it is broken when using long strings! See CW-756
    parallel:
        matrix:
            - MATRIX_NAME: [
                "snv-no-model-found", "snv-pass-model-v420",
                "snv-fail-model-v500", "snv-fail-model-mixed",
                "fail_depth_tumor", "fail_depth_normal",
                "fail_depth_both","fail_depth_tumor-only",
                "all", "unmap", "liquid-model",
                "input-multibam-dirs", "snv-r10-no_annot",
                "tumor-only", "tumor-only-fail", 
                "snv-bed", "snv-gvcf", 
                "wf-somatic-snv-r10-gt", "wf-somatic-snv-r10-hy",
                "snv-r10-normal_vcf", "snv-r10-som_only", 
                "snv-r10", "snv-r9", "snv-r10-fail",
                "sv", "sv-full", "mod", 
                "mod-strand", "mod-args"
            ]
    rules:
        # NOTE As we're overriding the rules block for the included docker-run
        #   we must redefine this CI_COMMIT_BRANCH rule to prevent docker-run
        #   being incorrectly scheduled for "detached merge request pipelines" etc.
        - if: ($CI_COMMIT_BRANCH == null || $CI_COMMIT_BRANCH == "dev-template")
          when: never
        - if: $MATRIX_NAME == "all"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_PROCESS_FILES: "modules/local/wf-somatic-snv.nf modules/local/wf-somatic-sv.nf workflows/mod.nf"
              NF_WORKFLOW_OPTS: "--sv --snv --mod --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 --min_sv_length 20 --min_support 2 --vaf_threshold 0.01 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  --severus_threads 4 \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "lookup_clair3_model,add_missing_vars,getVariantType,clairs_full_hap_filter,concat_hap_filtered_vcf"

        - if: $MATRIX_NAME == "unmap"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_PROCESS_FILES: "modules/local/wf-somatic-sv.nf"
              NF_WORKFLOW_OPTS: "--sv \
                  --sample_name SAMPLE \
                  --min_sv_length 20 --min_support 2 --vaf_threshold 0.01 \
                  --ubam_sort_threads 1 --ubam_map_threads 4 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/colo829bl.ubam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/colo829.ubam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  --severus_threads 4 \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "lookup_clair3_model,add_missing_vars,getVariantType,clairs_full_hap_filter,concat_hap_filtered_vcf"

        - if: $MATRIX_NAME == "snv-fail-model-v500"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_PROCESS_FILES: "modules/local/wf-somatic-sv.nf"
              NF_WORKFLOW_OPTS: "--snv \
                  --sample_name SAMPLE \
                  --ubam_sort_threads 1 --ubam_map_threads 4 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/colo829bl.ubam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/colo829.ubam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "lookup_clair3_model,add_missing_vars,getVariantType,clairs_full_hap_filter,concat_hap_filtered_vcf"
              ASSERT_NEXTFLOW_FAILURE: "yes"
              ASSERT_NEXTFLOW_FAILURE_REXP : "ClairS has not been trained on this basecalling configuration"

        - if: $MATRIX_NAME == "snv-fail-model-mixed"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--snv \
                  --sample_name SAMPLE \
                  --ubam_sort_threads 1 --ubam_map_threads 4 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --annotation false \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/colo829bl.SUPv420.ubam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/colo829.ubam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "lookup_clair3_model,add_missing_vars,getVariantType,clairs_full_hap_filter,concat_hap_filtered_vcf"
              ASSERT_NEXTFLOW_FAILURE: "yes"
              ASSERT_NEXTFLOW_FAILURE_REXP : "Your input tumor and/or normal BAM files indicate two different basecall models"

        - if: $MATRIX_NAME == "snv-pass-model-v420"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--snv \
                  --sample_name SAMPLE \
                  --ubam_sort_threads 1 --ubam_map_threads 4 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --annotation false \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/colo829bl.SUPv420.ubam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/colo829.SUPv420.ubam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "lookup_clair3_model,add_missing_vars,getVariantType,clairs_full_hap_filter,concat_hap_filtered_vcf"

        - if: $MATRIX_NAME == "invalid-model"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_PROCESS_FILES: "modules/local/wf-somatic-snv.nf"
              NF_WORKFLOW_OPTS: "--snv \
                  --sample_name SAMPLE \
                  --ubam_sort_threads 1 --ubam_map_threads 4 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/colo829bl.ubam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/colo829.ubam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "lookup_clair3_model,add_missing_vars,getVariantType,clairs_full_hap_filter,concat_hap_filtered_vcf"
              ASSERT_NEXTFLOW_FAILURE: "yes"
              ASSERT_NEXTFLOW_FAILURE_REXP : "ClairS has not been trained on this basecalling configuration"

        - if: $MATRIX_NAME == "snv-r9"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_PROCESS_FILES: "modules/local/wf-somatic-snv.nf"
              NF_WORKFLOW_OPTS: "--snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  --override_basecaller_cfg dna_r9.4.1_e8_sup@v3.3 \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,wf_build_regions,\
                  clairs_create_fullalignment_paired_tensors_indels,clairs_create_paired_tensors_indels,clairs_merge_final_indels,\
                  clairs_merge_full_indels,clairs_merge_pileup_indels,clairs_merge_snv_and_indels,clairs_predict_full_indels,concat_hap_filtered_vcf,\
                  clairs_predict_pileup_indel,lookup_clair3_model,add_missing_vars,getVariantType,clairs_hap_filter_indels,clairs_full_hap_filter"

        - if: $MATRIX_NAME == "snv-r10"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_PROCESS_FILES: "modules/local/wf-somatic-snv.nf"
              NF_WORKFLOW_OPTS: "--snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,concat_hap_filtered_vcf,\
                  getVariantType,summariseReads,lookup_clair3_model,clairs_merge_snv_and_indels,add_missing_vars,clairs_full_hap_filter"

        - if: $MATRIX_NAME == "snv-no-model-found"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_PROCESS_FILES: "modules/local/wf-somatic-snv.nf"
              NF_WORKFLOW_OPTS: "--snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,concat_hap_filtered_vcf,\
                  getVariantType,summariseReads,lookup_clair3_model,clairs_merge_snv_and_indels,add_missing_vars,clairs_full_hap_filter"
              ASSERT_NEXTFLOW_FAILURE: "yes"
              ASSERT_NEXTFLOW_FAILURE_REXP : "INPUT DATA PROBLEM"

        - if: $MATRIX_NAME == "snv-r10-no_annot"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_PROCESS_FILES: "modules/local/wf-somatic-snv.nf"
              NF_WORKFLOW_OPTS: "--snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
                  --annotation false \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,annotate_snv,concat_hap_filtered_vcf,\
                  getVariantType,summariseReads,lookup_clair3_model,clairs_merge_snv_and_indels,add_missing_vars,clairs_full_hap_filter"

        - if: $MATRIX_NAME == "snv-bed"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_PROCESS_FILES: "modules/local/wf-somatic-snv.nf"
              NF_WORKFLOW_OPTS: "--snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 20 --normal_min_coverage 10 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  --bed ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo.bed \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,concat_hap_filtered_vcf,\
                  getVariantType,summariseReads,lookup_clair3_model,clairs_merge_snv_and_indels,add_missing_vars,clairs_full_hap_filter"

        - if: $MATRIX_NAME == "snv-gvcf"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_PROCESS_FILES: "modules/local/wf-somatic-snv.nf"
              NF_WORKFLOW_OPTS: "--snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 --GVCF \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model,\
                  add_missing_vars,getVariantType,clairs_merge_snv_and_indels,clairs_full_hap_filter,concat_hap_filtered_vcf"

        - if: $MATRIX_NAME == "snv-r10-fail"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_PROCESS_FILES: "modules/local/wf-somatic-snv.nf"
              NF_WORKFLOW_OPTS: "--snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 40 --normal_min_coverage 40 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,wf_build_regions,clairs_create_fullalignment_paired_tensors_indels,\
                  clairs_create_paired_tensors_indels,clairs_merge_final_indels,clairs_merge_full_indels,clairs_merge_pileup_indels,clairs_merge_snv_and_indels,clairs_predict_full_indels,\
                  clairs_predict_pileup_indel,lookup_clair3_model,change_count,clairs_create_fullalignment_paired_tensors,clairs_create_paired_tensors,clairs_extract_candidates,\
                  clairs_full_hap_filter,clairs_haplotag,clairs_merge_final,clairs_merge_full,clairs_merge_pileup,clairs_phase,clairs_predict_full,clairs_predict_pileup,clairs_select_het_snps,\
                  vcfStats,add_missing_vars,getVariantType,concat_bams,concat_hap_filtered_vcf"

        - if: $MATRIX_NAME == "sv"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_PROCESS_FILES: "modules/local/wf-somatic-sv.nf"
              NF_WORKFLOW_OPTS: "--sv --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 --min_sv_length 20 --min_support 2 --vaf_threshold 0.01 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  --severus_threads 4 \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model"

        - if: $MATRIX_NAME == "sv-full"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_PROCESS_FILES: "modules/local/wf-somatic-sv.nf"
              NF_WORKFLOW_OPTS: "--sv --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 --min_sv_length 20 --min_support 2 --vaf_threshold 0.01 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  --tr_bed ./data/wf_str_repeats.bed.gz --severus_threads 4 \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model"

        - if: $MATRIX_NAME == "snv-r10-som_only"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  --germline false \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,\
                    lookup_clair3_model,clairs_select_het_snps,clairs_phase,clairs_haplotag,make_chunks,pileup_variants,\
                    aggregate_pileup_variants,select_het_snps,phase_contig,get_qual_filter,create_candidates,\
                    evaluate_candidates,aggregate_full_align_variants,merge_pileup_and_full_vars,aggregate_all_variants,\
                    add_missing_vars,getVariantType,clairs_full_hap_filter,concat_bams,concat_hap_filtered_vcf"

        - if: $MATRIX_NAME == "wf-somatic-snv-r10-gt"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --genotyping_mode_vcf https://bioinformatics.nygenome.org/wp-content/uploads/CancerCellLines/COLO-829-NovaSeq--COLO-829BL-NovaSeq.snv.indel.final.v6.annotated.vcf \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,\
                    lookup_clair3_model,clairs_select_het_snps,clairs_phase,clairs_haplotag,make_chunks,pileup_variants,\
                    aggregate_pileup_variants,select_het_snps,phase_contig,get_qual_filter,create_candidates,\
                    evaluate_candidates,aggregate_full_align_variants,merge_pileup_and_full_vars,aggregate_all_variants,\
                    add_missing_vars,getVariantType,clairs_full_hap_filter,concat_hap_filtered_vcf"

        - if: $MATRIX_NAME == "wf-somatic-snv-r10-hy"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --hybrid_mode_vcf https://bioinformatics.nygenome.org/wp-content/uploads/CancerCellLines/COLO-829-NovaSeq--COLO-829BL-NovaSeq.snv.indel.final.v6.annotated.vcf \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model,\
                    clairs_select_het_snps,clairs_phase,clairs_haplotag,make_chunks,pileup_variants,aggregate_pileup_variants,select_het_snps,\
                    phase_contig,get_qual_filter,create_candidates,evaluate_candidates,aggregate_full_align_variants,merge_pileup_and_full_vars,\
                    aggregate_all_variants,add_missing_vars,getVariantType,clairs_full_hap_filter,concat_hap_filtered_vcf"

        - if: $MATRIX_NAME == "snv-r10-normal_vcf"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  --normal_vcf ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/normal.vcf.gz \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model,\
                    clairs_merge_snv_and_indels,add_missing_vars,getVariantType,clairs_full_hap_filter,concat_hap_filtered_vcf"

        - if: $MATRIX_NAME == "liquid-model"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  --liquid_tumor --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_hac@v4.2.0 \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model,\
                    clairs_merge_snv_and_indels,add_missing_vars,getVariantType,clairs_full_hap_filter,concat_hap_filtered_vcf"

        - if: $MATRIX_NAME == "mod-args"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--mod --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  --modkit_args '--combine-mods --combine-strands --cpg' \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_PROCESS_FILES: "workflows/mod.nf"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model"

        - if: $MATRIX_NAME == "mod-strand"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--mod --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 --force_strand \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_PROCESS_FILES: "workflows/mod.nf"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model"

        - if: $MATRIX_NAME == "mod"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--mod --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_PROCESS_FILES: "workflows/mod.nf"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model"

        - if: $MATRIX_NAME == "tumor-only"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--mod --snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_PROCESS_FILES: "workflows/mod.nf"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model,\
                    dss,makeModReport"

        - if: $MATRIX_NAME == "tumor-only-fail"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--mod --sv --snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0  --min_sv_length 20 --min_support 2 --vaf_threshold 0.01 \
                  --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  --severus_threads 4 \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_PROCESS_FILES: "workflows/mod.nf"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model"
              ASSERT_NEXTFLOW_FAILURE: "yes"
              ASSERT_NEXTFLOW_FAILURE_REXP : "The tumor-only mode is not available with --sv"

        - if: $MATRIX_NAME == "input-multibam-dirs"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--mod --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/20240213_0958_1-AN-DN__fghij456/bam_pass/tumor/ \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/20240213_0951_0-AN-DN__abcde123/bam_pass/normal/ \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_PROCESS_FILES: "workflows/mod.nf"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model"

        - if: $MATRIX_NAME == "fail_depth_tumor"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--mod --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 1000 --normal_min_coverage 0 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_PROCESS_FILES: "workflows/mod.nf"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model,\
              validate_modbam,sample_probs,modkit,concat_bedmethyl,bedmethyl_split,summary,bed2dss,dss,makeModReport"

        - if: $MATRIX_NAME == "fail_depth_normal"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--mod --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 1000 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_PROCESS_FILES: "workflows/mod.nf"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model,\
              validate_modbam,sample_probs,modkit,concat_bedmethyl,bedmethyl_split,summary,bed2dss,dss,makeModReport"

        - if: $MATRIX_NAME == "fail_depth_both"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--mod --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 1000 --normal_min_coverage 1000 \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_PROCESS_FILES: "workflows/mod.nf"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model,\
              validate_modbam,sample_probs,modkit,concat_bedmethyl,bedmethyl_split,summary,bed2dss,dss,makeModReport"

        - if: $MATRIX_NAME == "fail_depth_tumor-only"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--mod --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 1000 \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  -c ${CI_PROJECT_NAME}/data/demo.nextflow.config"
              NF_PROCESS_FILES: "workflows/mod.nf"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model,\
              validate_modbam,sample_probs,modkit,concat_bedmethyl,bedmethyl_split,summary,bed2dss,dss,makeModReport"

aws-run:
    stage: test
    artifacts:
        when: always
        paths:
            - ${CI_PROJECT_NAME}
            - .nextflow.log
        exclude:
            - ${CI_PROJECT_NAME}/**/*.bam
            - ${CI_PROJECT_NAME}/**/*.cram
            - ${CI_PROJECT_NAME}/**/*.fa
            - ${CI_PROJECT_NAME}/**/*.fna
            - ${CI_PROJECT_NAME}/**/*.fasta
            - ${CI_PROJECT_NAME}/**/ref_cache/**
    variables:
        CWG_AWS_ENV_NAME: "stack"

    # Define a 1D job matrix to inject a variable named MATRIX_NAME into
    #   the CI environment, we can use the value of MATRIX_NAME to determine
    #   which options to apply as part of the rules block below
    # NOTE There is a slightly cleaner way to define this matrix to include
    #   the variables, but it is broken when using long strings! See CW-756
    parallel:
        matrix:
            - MATRIX_NAME: [
                "wf-somatic-tumor-only",
                "wf-somatic-variation"
              ]
    rules:
        # NOTE As we're overriding the rules block for the included docker-run
        #   we must redefine this CI_COMMIT_BRANCH rule to prevent docker-run
        #   being incorrectly scheduled for "detached merge request pipelines" etc.
        - if: ($CI_COMMIT_BRANCH == null || $CI_COMMIT_BRANCH == "dev-template")
          when: never

        - if: $MATRIX_NAME == "wf-somatic-tumor-only"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--mod --snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna"
              NF_PROCESS_FILES: "workflows/mod.nf"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model,\
                    dss,makeModReport"

        - if: $MATRIX_NAME == "wf-somatic-variation"
          variables:
              NF_BEFORE_SCRIPT: "mkdir -p ${CI_PROJECT_NAME}/data/ && wget -q -O ${CI_PROJECT_NAME}/data/demo_data.tar.gz https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo.tar.gz && tar -xzvf ${CI_PROJECT_NAME}/data/demo_data.tar.gz -C ${CI_PROJECT_NAME}/data/; wget -O ${CI_PROJECT_NAME}/data/demo.nextflow.config https://ont-exd-int-s3-euwst1-epi2me-labs.s3.amazonaws.com/wf-somatic-variation/wf-somatic-variation-demo/demo.nextflow.config"
              NF_WORKFLOW_OPTS: "--mod --sv --snv --sample_name SAMPLE --ubam_sort_threads 1 --ubam_map_threads 2 \
                  --tumor_min_coverage 0 --normal_min_coverage 0 \
                  --bam_tumor ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_tumor.bam \
                  --bam_normal ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/demo_normal.bam \
                  --override_basecaller_cfg dna_r10.4.1_e8.2_400bps_sup@v3.5.2 \
                  --ref ${CI_PROJECT_NAME}/data/wf-somatic-variation-demo/GCA_000001405.15_GRCh38_no_alt_analysis_set_chr20.fna \
                  --min_sv_length 20 --vaf_threshold 0.01 --min_support 2 --tr_bed ./data/wf_str_repeats.bed.gz --severus_threads 4"
              NF_PROCESS_FILES: "workflows/mod.nf"
              NF_IGNORE_PROCESSES: "getAllChromosomesBed,minimap2_ubam,getParams,getVersions,makeReport,summariseReads,lookup_clair3_model,\
                    dss,makeModReport"

macos-run:
  # Let's avoid those ARM64 runners for now
  tags:
    - macos
    - x86
